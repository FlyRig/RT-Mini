var g_t0_MAX=123e14;function CHit(){this.hitGeom=null,this.hitNum=-1,this.t0=g_t0_MAX,this.hitPt=glMatrix.vec4.create(),this.surfNorm=glMatrix.vec4.create(),this.viewN=glMatrix.vec4.create(),this.isEntering=!0,this.modelHitPt=glMatrix.vec4.create(),this.colr=glMatrix.vec4.clone(g_myScene.skyColor)}function CHitList(){this.pierce=[],this.iEnd=0,this.iNearest=0}function CScene(){this.RAY_EPSILON=2e-6,this.imgBuf=g_myPic,this.eyeRay=new CRay,this.rayCam=new CCamera,this.item=[]}CHit.prototype.init=function(){this.hitGeom=-1,this.hitNum=-1,this.t0=g_t0_MAX,glMatrix.vec4.set(this.hitPt,this.t0,0,0,1),glMatrix.vec4.set(this.surfNorm,-1,0,0,0),glMatrix.vec4.set(this.viewN,-1,0,0,0),this.isEntering=!0,glMatrix.vec4.copy(this.modelHitPt,this.hitPt)},CHitList.prototype.append=function(t){this.pierce[this.iEnd]=t,this.iEnd++},CScene.prototype.setImgBuf=function(t){this.rayCam.setSize(t.xSiz,t.ySiz),this.imgBuf=t},CScene.prototype.initScene=function(){this.rayCam.rayPerspective(camera.fov,camera.perAspect,camera.znear),this.rayCam.rayLookAt(camera.eyePoint,camera.lookPoint,camera.upV),this.setImgBuf(g_myPic),this.item.length=0;var t=matter.length=0;switch(g_SceneNum){default:case 0:this.skyColor=glMatrix.vec4.fromValues(.2,.7,.7,1),matter.push(new Material(2)),matter.push(new Material(20)),matter.push(new Material(18)),matter.push(new Material(1)),matter.push(new Material(3)),matter.push(new Material(12)),matter.push(new Material(23)),matter.push(new Material(24)),camera.eyePoint[0]=5.26588,camera.eyePoint[1]=2.03795,camera.eyePoint[2]=5.9164667,camera.yawInit=-2.674836245760751,camera.pitchInit=-.6714504655472818,clearMouse(),lamp[0].turnOn(),lamp[0].setAmbi([.3,.3,.3]),lamp[0].setDiff([3,3,3]),lamp[1].turnOn(),lamp[1].I_pos[0]=0,lamp[1].I_pos[1]=0,lamp[1].I_pos[2]=4,lamp[1].setAmbi([0,0,0]),lamp[1].setDiff([1,1,1]),initPage(),this.item.push(new CGeom(RT_GNDPLANE)),t=this.item.length-1,this.item[t].lineColor=matter[0],this.item[t].gapColor=matter[1],this.item.push(new CGeom(RT_DISK)),t=this.item.length-1,this.item[t].gapColor=matter[2],this.item[t].lineColor=matter[3],this.item[t].setIdent(),this.item[t].rayTranslate(1,1,1.3),this.item[t].rayRotate(.25*Math.PI,1,0,0),this.item[t].rayRotate(.25*Math.PI,0,0,1),this.item[t].rayScale(2,2,2),this.item.push(new CGeom(RT_DISK)),t=this.item.length-1,this.item[t].gapColor=matter[4],this.item[t].lineColor=matter[5],this.item[t].setIdent(),this.item[t].rayTranslate(-1,1,1.3),this.item[t].rayRotate(.75*Math.PI,1,0,0),this.item[t].rayRotate(Math.PI/3,0,0,1),this.item[t].rayScale(2,2,2),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[7],this.item[t].setIdent(),this.item[t].rayTranslate(1.2,-1,1),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[6],this.item[t].setIdent(),this.item[t].rayTranslate(-4.5,-6,1),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[3],this.item[t].setIdent(),this.item[t].rayTranslate(-4,-2,1.5),this.item[t].rayRotate(.25*Math.PI,0,1,0),this.item.push(new CGeom(RT_CYLINDER)),t=this.item.length-1,this.item[t].lineColor=matter[4],this.item[t].setIdent(),this.item[t].rayTranslate(-.75,-2.5,1.7),this.item[t].rayRotate(.6*Math.PI,-.8,1,0);break;case 1:this.skyColor=glMatrix.vec4.fromValues(.2,.7,.3,1),matter.push(new Material(14)),matter.push(new Material(7)),matter.push(new Material(23)),matter.push(new Material(18)),matter.push(new Material(16)),matter.push(new Material(6)),matter.push(new Material(19)),camera.eyePoint[0]=-2.9943947792053223,camera.eyePoint[1]=9.89196491241455,camera.eyePoint[2]=3.9114582538604736,camera.yawInit=-1.3365719459579886,camera.pitchInit=-.37472162772253714,clearMouse(),lamp[0].turnOn(),lamp[0].setAmbi([.3,.3,.3]),lamp[0].setDiff([1,1,1]),lamp[1].turnOn(),lamp[1].I_pos[0]=0,lamp[1].I_pos[1]=3,lamp[1].I_pos[2]=7,lamp[1].setAmbi([0,0,0]),lamp[1].setDiff([3,3,3]),initPage(),this.item.push(new CGeom(RT_GNDPLANE)),t=this.item.length-1,this.item[t].lineColor=matter[0],this.item[t].gapColor=matter[1],this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].setIdent(),this.item[t].rayTranslate(-4,-1,2),this.item[t].rayScale(1,1,2),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].setIdent(),this.item[t].rayTranslate(1,-3,.5),this.item[t].rayRotate(-.25*Math.PI,0,0,1),this.item[t].rayScale(1,2,.5),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].setIdent(),this.item[t].rayTranslate(2,2,1),this.item[t].rayRotate(-.35*Math.PI,0,0,1),this.item[t].rayScale(3,.75,1),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[3],this.item[t].setIdent(),this.item[t].rayTranslate(-3,5,1),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[4],this.item[t].setIdent(),this.item[t].rayTranslate(3,-6,1.5),this.item[t].rayRotate(.4,0,0,1),this.item[t].rayScale(1,1,1.5),this.item.push(new CGeom(RT_CYLINDER)),t=this.item.length-1,this.item[t].lineColor=matter[5],this.item[t].setIdent(),this.item[t].rayTranslate(-2,0,.25),this.item[t].rayRotate(.5*Math.PI,1,-.25,0),this.item[t].rayScale(.25,.25,4),this.item.push(new CGeom(RT_CYLINDER)),t=this.item.length-1,this.item[t].lineColor=matter[6],this.item[t].setIdent(),this.item[t].rayTranslate(-.5,5,0),this.item[t].rayScale(1,.25,1.5);break;case 2:this.skyColor=glMatrix.vec4.fromValues(0,0,0,1),matter.push(new Material(26)),matter.push(new Material(25)),matter.push(new Material(23)),matter.push(new Material(24)),camera.eyePoint[0]=-5.858597278594971,camera.eyePoint[1]=11.463932991027832,camera.eyePoint[2]=4.423532485961914,camera.yawInit=-1.15018141341361,camera.pitchInit=-.2771120659695489,clearMouse(),lamp[0].turnOn(),lamp[0].setAmbi([.5,.5,.5]),lamp[0].setDiff([1,1,1]),lamp[1].turnOn(),lamp[1].I_pos[0]=0,lamp[1].I_pos[1]=0,lamp[1].I_pos[2]=5,lamp[1].setAmbi([0,0,0]),lamp[1].setDiff([3,3,3]),initPage(),this.item.push(new CGeom(RT_GNDPLANE)),t=this.item.length-1,this.item[t].lineColor=matter[0],this.item[t].gapColor=matter[1],this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[3],this.item[t].rayTranslate(0,0,1.25),this.item[t].rayScale(1.25,1.25,1.25),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].rayTranslate(5,0,1),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].rayTranslate(-5,0,1),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].rayTranslate(0,5,1),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].rayTranslate(0,-5,1),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[1],this.item[t].rayTranslate(6,-6,1.25),this.item[t].rayScale(.5,.5,1.25),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[1],this.item[t].rayTranslate(-6,6,1.25),this.item[t].rayScale(.5,.5,1.25),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[0],this.item[t].rayTranslate(-6,-6,.75),this.item[t].rayScale(.5,.5,.75),this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[0],this.item[t].rayTranslate(6,6,.75),this.item[t].rayScale(.5,.5,.75);break;case 3:this.skyColor=glMatrix.vec4.fromValues(.6,.2,.2,1),matter.push(new Material(1)),matter.push(new Material(2)),matter.push(new Material(3)),matter.push(new Material(20)),matter.push(new Material(18)),matter.push(new Material(25)),matter.push(new Material(21)),matter.push(new Material(8)),matter.push(new Material(23)),camera.eyePoint[0]=-7.7614850997924805,camera.eyePoint[1]=-6.381804943084717,camera.eyePoint[2]=4.696640968322754,camera.yawInit=.46784530491232523,camera.pitchInit=-.13500508406111703,clearMouse(),lamp[0].turnOn(),lamp[0].setAmbi([.5,.5,.5]),lamp[0].setDiff([1,1,1]),lamp[1].turnOn(),lamp[1].I_pos[0]=-2,lamp[1].I_pos[1]=-2,lamp[1].I_pos[2]=8,lamp[1].setAmbi([0,0,0]),lamp[1].setDiff([3,3,3]),initPage(),this.item.push(new CGeom(RT_GNDPLANE)),t=this.item.length-1,this.item[t].lineColor=matter[0],this.item[t].gapColor=matter[1],this.item.push(new CGeom(RT_BOX)),t=this.item.length-1,this.item[t].lineColor=matter[6],this.item[t].rayTranslate(0,0,1),this.item.push(new CGeom(RT_CYLINDER)),t=this.item.length-1,this.item[t].lineColor=matter[3],this.item[t].rayTranslate(0,0,2),this.item[t].rayScale(.25,.25,2),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[4],this.item[t].rayTranslate(0,0,4),this.item[t].rayScale(.5,.5,.5),this.item.push(new CGeom(RT_CYLINDER)),t=this.item.length-1,this.item[t].lineColor=matter[5],this.item[t].rayTranslate(0,0,4),this.item[t].rayRotate(.25*Math.PI,1,0,0),this.item[t].rayScale(.15,.15,2),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[2],this.item[t].rayTranslate(0,-1.5,5.5),this.item[t].rayScale(.75,.75,.75),this.item.push(new CGeom(RT_CYLINDER)),t=this.item.length-1,this.item[t].lineColor=matter[7],this.item[t].rayTranslate(0,-1.5,5.5),this.item[t].rayRotate(.5*Math.PI,1,0,0),this.item[t].rayScale(.15,.15,3),this.item.push(new CGeom(RT_SPHERE)),t=this.item.length-1,this.item[t].lineColor=matter[8],this.item[t].rayTranslate(0,-4.5,5.5),this.item[t].rayScale(.25,.75,1)}},CScene.prototype.makeRayTracedImage=function(){this.rayCam.rayPerspective(camera.fov,camera.perAspect,camera.znear),this.rayCam.rayLookAt(camera.eyePoint,camera.lookPoint,camera.upV),this.setImgBuf(this.imgBuf);var t,e,i,a=glMatrix.vec4.create();this.pixFlag=0;for(var r=new Array(g_AAcode*g_AAcode),s=0;s<r.length;s++)r[s]=new CHit;for(var m=1/g_AAcode,h=.5*m,l=0;l<this.imgBuf.ySiz;l++)for(e=0;e<this.imgBuf.xSiz;e++){for(s=0;s<g_AAcode;s++)for(i=0;i<g_AAcode;i++){0==g_isJitter?this.rayCam.setEyeRay(this.eyeRay,e+h+m*s,l+h+m*i):this.rayCam.setEyeRay(this.eyeRay,e+m*s+Math.random()*m,l+m*i+Math.random()*m);var n=s*g_AAcode+i;this.traceRay(this.eyeRay,r[n]),this.findShade(this.eyeRay,r[n])}for(this.pixFlag=0,glMatrix.vec4.set(a,0,0,0,0),s=0;s<r.length;s++)void 0!==r[s].colr.K_diff?glMatrix.vec3.add(a,a,r[s].colr.K_diff):glMatrix.vec3.add(a,a,r[s].colr);glMatrix.vec3.scale(a,a,1/r.length),a[3]=1,t=(l*this.imgBuf.xSiz+e)*this.imgBuf.pixSiz,this.imgBuf.fBuf[t]=a[0],this.imgBuf.fBuf[1+t]=a[1],this.imgBuf.fBuf[2+t]=a[2]}this.imgBuf.float2int()},CScene.prototype.traceRay=function(t,e){for(e.init(),k=0;k<this.item.length;k++)this.item[k].traceMe(t,e);e.hitNum},CScene.prototype.findShade=function(t,e){if(0==e.hitNum)e.colr=new Material(e.hitGeom.gapColor.K_matlNum);else{if(1!=e.hitNum)return void(e.colr=glMatrix.vec4.clone(this.skyColor));e.colr=new Material(e.hitGeom.lineColor.K_matlNum)}var i=this.findLampVector(lamp,e),a=glMatrix.vec4.clone(e.viewN),r=glMatrix.vec4.clone(e.surfNorm);glMatrix.vec3.normalize(r,r),glMatrix.vec3.angle(a,r)>Math.PI/2&&(glMatrix.vec3.negate(r,r),glMatrix.vec3.angle(a,r));var s=glMatrix.vec4.clone(e.colr.K_emit);for(ind=0;ind<i.length;ind++){var m=this.shadeAmbi(lamp[ind],e);glMatrix.vec3.add(s,s,m);var h,l=glMatrix.vec3.distance(lamp[ind].I_pos,e.hitPt);this.isInShadow(i[ind],l)||(h=this.shadeDiff(lamp[ind],e,r,i[ind]),m=this.shadeSpec(lamp[ind],e,r,i[ind],a),glMatrix.vec3.add(h,h,m),lamp[ind].attn?glMatrix.vec3.scaleAndAdd(s,s,h,1/l):glMatrix.vec3.add(s,s,h))}var n,o,c,p=e.colr.K_refl,g=e.colr.K_tran,y=e.colr.K_refr;e.colr=glMatrix.vec4.clone(s),t.recurseLevel!=g_maxRecursion&&(p>g_minRefl&&(n=new CRay,glMatrix.vec4.copy(n.orig,e.hitPt),glMatrix.vec4.scaleAndAdd(n.orig,n.orig,e.viewN,this.RAY_EPSILON),n.dir=this.reflect(t.dir,r),glMatrix.vec3.negate(n.dir,n.dir),n.recurseLevel=t.recurseLevel+1,c=new CHit,this.traceRay(n,c),this.findShade(n,c),glMatrix.vec3.scale(c.colr,c.colr,p),glMatrix.vec3.add(e.colr,e.colr,c.colr)),g>g_minTran&&(n=new CRay,glMatrix.vec3.negate(a,a),glMatrix.vec4.copy(n.orig,e.hitPt),glMatrix.vec4.scaleAndAdd(n.orig,n.orig,e.viewN,-this.RAY_EPSILON),o=y/1.000277,p=glMatrix.vec4.create(),glMatrix.vec3.scale(p,a,o),y=glMatrix.vec3.dot(r,a),y=Math.sqrt(1-o*o*(1-y*y)),o=o*glMatrix.vec3.dot(r,a),o-=y,glMatrix.vec3.scale(n.dir,r,o),glMatrix.vec3.add(n.dir,n.dir,p),n.recurseLevel=t.recurseLevel+1,c=new CHit,this.traceRay(n,c),this.findShade(n,c),glMatrix.vec3.scale(c.colr,c.colr,g),glMatrix.vec3.add(e.colr,e.colr,c.colr)))},CScene.prototype.shadeAmbi=function(t,e){t=glMatrix.vec3.clone(t.I_ambi);return glMatrix.vec3.multiply(t,t,e.colr.K_ambi),t},CScene.prototype.shadeDiff=function(t,e,i,a){t=glMatrix.vec3.clone(t.I_diff);glMatrix.vec3.multiply(t,t,e.colr.K_diff);a=Math.max(0,glMatrix.vec3.dot(i,a.dir));return glMatrix.vec3.scale(t,t,a),t},CScene.prototype.shadeSpec=function(t,e,i,a,r){t=glMatrix.vec3.clone(t.I_spec);glMatrix.vec3.multiply(t,t,e.colr.K_spec);r=Math.max(0,glMatrix.vec3.dot(this.reflect(a.dir,i),r)),r=Math.pow(r,e.colr.K_shiny);return glMatrix.vec3.scale(t,t,r),t},CScene.prototype.findLampVector=function(t,e){for(var i,a=new Array(t.length),r=0;r<a.length;r++)i=new CRay,glMatrix.vec4.copy(i.orig,e.hitPt),glMatrix.vec4.scaleAndAdd(i.orig,i.orig,e.viewN,this.RAY_EPSILON),glMatrix.vec4.subtract(i.dir,lamp[r].I_pos,i.orig),glMatrix.vec4.normalize(i.dir,i.dir),a[r]=i;return a},CScene.prototype.isInShadow=function(t,e){var i=new CHit;return this.traceRay(t,i),-1!=i.hitNum&&i.t0<e},CScene.prototype.reflect=function(t,e){var i=glMatrix.vec4.create(),a=glMatrix.vec3.dot(t,e);return glMatrix.vec4.scale(i,e,2*a),glMatrix.vec4.subtract(i,i,t),i[3]=0,i};